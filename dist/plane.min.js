function C(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function c(e){let t=C(e);if(t==0)return e;let i=1/t;return new Float32Array([e[0]*i,e[1]*i,e[2]*i])}function v(e,t){return new Float32Array([e[0]-t[0],e[1]-t[1],e[2]-t[2]])}function f(e,t){return new Float32Array([e[1]*t[2]-t[1]*e[2],e[2]*t[0]-t[2]*e[0],e[0]*t[1]-t[0]*e[1]])}function l(e,t){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function n(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function w(e,t,i,s){let r=1/Math.tan(e/2);return new Float32Array([r/t,0,0,0,0,r,0,0,0,0,(s+i)/(i-s),-1,0,0,2*s*i/(i-s),0])}function M(e,t,i,s,r,a){let h=t+e,o=t-e,D=s+i,g=s-i,I=a+r,m=a-r;return new Float32Array([2/o,0,0,-h/o,0,2/g,0,-D/g,0,0,-2/m,-I/m,0,0,0,1])}function A(e,t,i){let s=new Float32Array(16),r=c(i),a=c(v(e,t)),h=c(f(r,a)),o=c(f(a,h));return s[0]=h[0],s[1]=o[0],s[2]=a[0],s[3]=0,s[4]=h[1],s[5]=o[1],s[6]=a[1],s[7]=0,s[8]=h[2],s[9]=o[2],s[10]=a[2],s[11]=0,s[12]=-l(h,e),s[13]=-l(o,e),s[14]=-l(a,e),s[15]=1,s}function F(e){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e[0],e[1],e[2],1])}function U(e){let t=n(),i=n(),s=n();return t[5]=Math.cos(e[0]),t[6]=-Math.sin(e[0]),t[9]=Math.sin(e[0]),t[10]=Math.cos(e[0]),i[0]=Math.cos(e[1]),i[2]=Math.sin(e[1]),i[8]=-Math.sin(e[1]),i[10]=Math.cos(e[1]),s[0]=Math.cos(e[2]),s[1]=-Math.sin(e[2]),s[4]=Math.sin(e[2]),s[5]=Math.cos(e[2]),u(t,u(i,s))}function u(e,t){let i=new Float32Array(16);return i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[4]=e[0]*t[4]+e[4]*t[5]+e[8]*t[6]+e[12]*t[7],i[8]=e[0]*t[8]+e[4]*t[9]+e[8]*t[10]+e[12]*t[11],i[12]=e[0]*t[12]+e[4]*t[13]+e[8]*t[14]+e[12]*t[15],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[5]=e[1]*t[4]+e[5]*t[5]+e[9]*t[6]+e[13]*t[7],i[9]=e[1]*t[8]+e[5]*t[9]+e[9]*t[10]+e[13]*t[11],i[13]=e[1]*t[12]+e[5]*t[13]+e[9]*t[14]+e[13]*t[15],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[6]=e[2]*t[4]+e[6]*t[5]+e[10]*t[6]+e[14]*t[7],i[10]=e[2]*t[8]+e[6]*t[9]+e[10]*t[10]+e[14]*t[11],i[14]=e[2]*t[12]+e[6]*t[13]+e[10]*t[14]+e[14]*t[15],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i[7]=e[3]*t[4]+e[7]*t[5]+e[11]*t[6]+e[15]*t[7],i[11]=e[3]*t[8]+e[7]*t[9]+e[11]*t[10]+e[15]*t[11],i[15]=e[3]*t[12]+e[7]*t[13]+e[11]*t[14]+e[15]*t[15],i}var B=class{constructor(t=60){this._counter=0,this._fps=60,this._dt=0,this._lastTime=Date.now(),this._animate=!1,this._requestFrameId=void 0,this._subscribers=[]}start(){this._animate=!0,this._requestFrameId||(this._requestFrameId=window.requestAnimationFrame(()=>this.frame()),this._lastTime=Date.now())}stop(){this._animate=!1,this._requestFrameId&&(window.cancelAnimationFrame(this._requestFrameId),this._requestFrameId=void 0)}animate(t){this._subscribers.includes(t)||(this._subscribers.push(t),this._animate||this.start())}release(t){if(this._subscribers.includes(t)){let s=0;for(var i of this._subscribers){if(i===t)break;s++}this._subscribers.splice(s,1)}}frame(){var t=Date.now(),i=t-this._lastTime;this._counter++;for(var s of this._subscribers)s.update(i);if(this._subscribers.length==0){this.stop();return}this._animate&&(this._requestFrameId=window.requestAnimationFrame(()=>this.frame())),this._lastTime=t}},O=new B,x=O;var S=class{constructor(){this.update(),window.addEventListener("resize",()=>this.update(),!1)}get safari(){return this._isSafari}get mobile(){return this._isMobile}get touchdevice(){return this._istouch}get vpw(){return this._vpw}get vph(){return this._vph}get retina(){return this._isRetina}update(){this._isSafari=!1,this._isChrome=!1,this._isMobile=window.matchMedia("only screen and (max-width: 760px)").matches,this._istouch="ontouchstart"in document.documentElement,this._vpw=window.innerWidth,this._vph=window.innerHeight,this._isRetina=window.devicePixelRatio>1;var t=navigator.userAgent.toLowerCase();t.indexOf("safari")!=-1&&(t.indexOf("chrome")>-1?this._isChrome=!0:this._isSafari=!0)}},X=new S,d=X;var b=class{constructor(){this.vpHeight=0,this.vpWidth=0,this.aspectRatio=16/9,this._projectionMatrix=n(),this._viewMatrix=n(),this._vpMatrix=n(),this._pendingMatrixUpdates=!0,this.isOrtho=!0,this.near=-5e3,this.far=5e3}get viewProjectionMatrix(){return this.update(),this._vpMatrix}get hasPendingUpdates(){return this._pendingMatrixUpdates}setViewport(t,i){this.vpWidth=t,this.vpHeight=i,this._pendingMatrixUpdates=!0}setPerspective(){this._projectionMatrix=w(45*Math.PI/180,this.aspectRatio,1,100),this.isOrtho=!1,this._pendingMatrixUpdates=!0}setOrtho(){this._projectionMatrix=M(-this.aspectRatio,this.aspectRatio,-1,1,this.near,this.far),this.isOrtho=!0,this._pendingMatrixUpdates=!0}lookAt(t,i,s){this._viewMatrix=A(t,i,s),this._pendingMatrixUpdates=!0}update(){this._pendingMatrixUpdates&&(this.aspectRatio=this.vpWidth/this.vpHeight,this.isOrtho?this.setOrtho():this.setPerspective(),this._vpMatrix=u(this._projectionMatrix,this._viewMatrix),this._pendingMatrixUpdates=!1)}};var T=class{constructor(){this._gl_texture=null,this.gl=null,this.url=null,this._isLoaded=!1,this.width=0,this.height=0,this.internalFormat=null}init(t,i,s){this.width=i,this.height=s,this._gl_texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._gl_texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}initFromURL(t,i){this.gl=t,this.url=i,this._isLoaded=!1,this.loadFromImage(this.gl)}get glTexture(){return this._gl_texture}get isLoaded(){return this._isLoaded}loadFromImage(t){this._gl_texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._gl_texture);let i=new Uint8Array([255,0,0,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,i);let s=new Image;s.onload=()=>{t.bindTexture(t.TEXTURE_2D,this._gl_texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.MIRRORED_REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.MIRRORED_REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),this._isLoaded=!0},s.src=this.url}isPowerOf2(t){return(t&t-1)==0}};var V=`
    attribute vec3 position; 
    attribute vec2 texcoord; 

    uniform mat4 vpMat;
    uniform mat4 modelMat;
    varying vec2 vUV;

    void main() 
    { 
        mat4 mvpMatrix = vpMat * modelMat;
        gl_Position = mvpMatrix * vec4( position, 1.0 ); 
        vUV = texcoord;
    }
`,j=`
    uniform vec2 resolution; 
    uniform sampler2D texture;
    uniform float time;
    
    varying vec2 vUV;

    void main( void )
    {         
        // Final color
        gl_FragColor = vec4(vUV.x-vUV.y/2.0, 0.0, vUV.y, 1.0);

        // Premultiply canvas output
        gl_FragColor.rgb *= gl_FragColor.a;
    }
`,_=class{constructor(){this.program=null,this._matrixLocation=null,this._modelMatLocation=null,this._resolutionLocation=null,this._textureLocation=null,this._timeLocation=null}init(t){this.gl=t,this.program=this.createProgram(t,this.vertexShader,this.fragmentShader),this._matrixLocation=this.gl.getUniformLocation(this.program,"vpMat"),this._modelMatLocation=this.gl.getUniformLocation(this.program,"modelMat"),this._resolutionLocation=this.gl.getUniformLocation(this.program,"resolution"),this._timeLocation=this.gl.getUniformLocation(this.program,"time")}get vertexShader(){return V}get fragmentShader(){return j}useProgram(){this.gl.useProgram(this.program)}bindTexture(t,i=0){this.gl.activeTexture(i==0?this.gl.TEXTURE0:this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"texture"),i)}set vpMatrix(t){this.gl.uniformMatrix4fv(this._matrixLocation,!1,t)}set modelMatrix(t){this.gl.uniformMatrix4fv(this._modelMatLocation,!1,t)}set resolution(t){this.gl.uniform2f(this._resolutionLocation,t[0],t[1])}set time(t){this.gl.uniform1f(this._timeLocation,t)}createProgram(t,i,s){var r=t.createProgram(i,s),a=this.createShader(t,i,t.VERTEX_SHADER),h=this.createShader(t,`#ifdef GL_ES
precision highp float;
#endif

`+s,t.FRAGMENT_SHADER);return a==null||h==null?(console.log("ERROR while creating shaders"),null):(t.attachShader(r,a),t.attachShader(r,h),t.deleteShader(a),t.deleteShader(h),t.bindAttribLocation(r,0,"position"),t.bindAttribLocation(r,1,"texcoord"),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS)?r:(console.log(`ERROR:
VALIDATE_STATUS: `+t.getProgramParameter(r,t.VALIDATE_STATUS)+`
ERROR: `+t.getError()+`

- Vertex Shader -
`+i+`

- Fragment Shader -
`+s),null))}createShader(t,i,s){var r=t.createShader(s);return t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(console.log((s==t.VERTEX_SHADER?"VERTEX":"FRAGMENT")+` SHADER:
`+t.getShaderInfoLog(r)),null)}};var L=class{constructor(){}update(t){}surfaceDidChange(t,i,s){}},R=class{constructor(){this.texture=null,this._opacity=1,this._rotation=[0,0,0],this._position=[0,0,0],this.mtrans=n(),this.mrot=n(),this._mMatrix=n(),this._pendingMatrixUpdates=!1,this.shader=new _}init(t){this.shader.init(t)}get position(){return this._position}set position(t){this.translate(t[0],t[1],t[2])}get opacity(){return this._opacity}set opacity(t=1){this._opacity=t}get hasTexture(){return this.texture!=null}get modelMatrix(){return this.updateMatrix(),this._mMatrix}rotate(t,i,s){(this._rotation[0]!=t||this._rotation[1]!=i||this._rotation[2]!=s)&&(this._rotation=[t,i,s],this.mrot=U([t,i,s]),this._pendingMatrixUpdates=!0)}translate(t,i,s){(this._position[0]!=t||this._position[1]!=i||this._position[2]!=s)&&(this._position=[t,i,s],this.mtrans=F([t,i,s]),this._pendingMatrixUpdates=!0)}updateMatrix(){this._pendingMatrixUpdates&&(this._mMatrix=u(this.mtrans,this.mrot),this._pendingMatrixUpdates=!1)}draw(t){}};var p=class extends R{constructor(){super();this.width=2,this.height=2,this.vertices=[],this._vbo_stride=5}init(t){super.init(t),this._vbo=t.createBuffer(),this.generateTriangles()}get triangleCount(){return this.vertices.length/3}generateTriangles(){this.vertices=[];let t=this.width/2,i=this.height/2;this.vertices.push([-t,-i,0,0,0]),this.vertices.push([t,-i,0,1,0]),this.vertices.push([t,i,0,1,1]),this.vertices.push([-t,i,0,0,1]),this.vertices.push([-t,-i,0,0,0]),this.vertices.push([t,i,0,1,1]),this.updateVBO()}updateGeometry(){this.generateTriangles()}updateVBO(){this._vbo_need_updates=!0}generateVBO(t){if(this._vbo_need_updates){this._vdata=new Float32Array(this.vertices.length*this._vbo_stride);let s=0;for(var i of this.vertices)this._vdata[s]=i[0],this._vdata[s+1]=i[1],this._vdata[s+2]=i[2],this._vdata[s+3]=i[3],this._vdata[s+4]=i[4],s+=this._vbo_stride;t.bindBuffer(t.ARRAY_BUFFER,this._vbo),t.bufferData(t.ARRAY_BUFFER,this._vdata,t.STATIC_DRAW),this._vbo_need_updates=!1}}draw(t){super.draw(t),this.generateVBO(t);var i;t.bindBuffer(t.ARRAY_BUFFER,this._vbo),t.vertexAttribPointer(0,3,t.FLOAT,!1,20,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,20,12),t.enableVertexAttribArray(1),t.drawArrays(t.TRIANGLES,0,this.vertices.length),t.disableVertexAttribArray(i)}};var E=class{constructor(t,i,s){this.gl=t,this.texture=new T,this.texture.init(this.gl,i,s),this.glBuffer=this.gl.createFramebuffer(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.glBuffer),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.texture.glTexture,0)}},y=class extends _{constructor(){super()}get fragmentShader(){return`
            uniform vec2 resolution; 
            uniform sampler2D texture;

            void main( void ){         
                gl_FragColor = texture2D(texture, vec2(gl_FragCoord.x/ resolution.x, gl_FragCoord.y/ resolution.y));
            }
        `}},P=class{constructor(t=null,i){this._canvas=t,this.gl=null,this.width=0,this.height=0,this._density=1,this._sceneController=i,this._scene=[],this._camera=null,this._mvpMatrix=n,this._isRunning=!1,this._delayedResizing=null,this._bg=[0,0,0,0],this.init(),this._doubleBuffering=!1,this._isRenderingToBuffer=!1,this._buffers=[],this._bIndex=0,this._bufferQuad=null}init(){try{this.gl=this._canvas.getContext("webgl")}catch(t){console.log("Cannot create webGL context");return}this._camera=new b,this._camera.setPerspective(),this._camera.lookAt([0,0,3],[0,0,0],[0,1,0]),window.addEventListener("resize",()=>this.resize(),!1),this.resize()}initBuffers(){this.doubleBuffering&&(this._buffers[0]=new E(this.gl,this.width,this.height),this._buffers[1]=new E(this.gl,this.width,this.height),this._fbIndex=0,this._bufferQuad==null&&(this._bufferQuad=new p,this._bufferQuad.shader=new y,this._bufferQuad.init(this.gl)))}bindBuffer(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.frontBuffer.glBuffer)}swapBuffers(){this._bIndex=1-this._bIndex}get frontBuffer(){return this._buffers[this._bIndex]}get backBuffer(){return this._buffers[1-this._bIndex]}get density(){return this._density}get canvas(){return this._canvas}get context(){return this.gl}get bgColor(){return this._bg}set bgColor(t){this._bg=t,this._bg[3]=1}get camera(){return this._camera}get doubleBuffering(){return this._doubleBuffering}set doubleBuffering(t=!1){t?(this._doubleBuffering=!0,this.initBuffers()):this._doubleBuffering=!1}clearScene(){this._scene=[]}addSceneNode(t){t.init(this.gl),this._scene.push(t)}start(){this._isRunning||(this._isRunning=!0,x.animate(this))}stop(){this._isRunning&&(this._isRunning=!1,x.release(this),this.clearCanvas())}update(t){this._sceneController!=null&&this._sceneController.update(t),!!this._isRunning&&(this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.BLEND),this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.BACK),this.gl.enable(this.gl.DEPTH_TEST),this.doubleBuffering&&this.bindBuffer(),this.clearCanvas(),this.renderScene(),this.doubleBuffering&&(this.renderBuffer(),this.swapBuffers()))}renderScene(){for(var t of this._scene){if(!t.shader.program){console.log("Invalid shader program");continue}t.shader.useProgram(),t.hasTexture&&t.shader.bindTexture(t.texture.glTexture),this.doubleBuffering&&(t.shader.bindTexture(this.backBuffer.texture.glTexture,1),t.shader.useRenderedTexture=!1),t.shader.vpMatrix=this._camera.viewProjectionMatrix,t.shader.modelMatrix=t.modelMatrix,t.shader.resolution=[this.width,this.height],t.draw(this.gl)}}renderBuffer(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this._bufferQuad.shader.bindTexture(this.frontBuffer.texture.glTexture,1),this._bufferQuad.resolution=[this.width,this.height],this._bufferQuad.draw(this.gl)}clearCanvas(){this.gl.clearColor(this._bg[0],this._bg[1],this._bg[2],this._bg[3]),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}resize(t=!1){if(this._canvas==null)return;this._density=d.retina?2:1;let i=d.vpw*this._density,s=d.vph*this._density;if(this.width=i,this.height=s,this._canvas.width=this.width,this._canvas.height=this.height,this._canvas.style.width=d.vpw+"px",this._canvas.style.height=d.vph+"px",t){this.resizeViewport();return}this._delayedResizing!=null&&clearTimeout(this._delayedResizing),this._delayedResizing=setTimeout(()=>{this._delayedResizing=null,this.resizeViewport()},100)}resizeViewport(){this.initBuffers(),this.gl.viewport(0,0,this.width,this.height),this._camera.setViewport(this.width,this.height),this._sceneController.surfaceDidChange(this.width,this.height,this._density)}};export{P as Renderer,L as SceneController,_ as Shader,p as Shape};
